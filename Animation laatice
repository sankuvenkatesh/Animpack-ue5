bl_info = {
    "name": "Anim Lattice FINAL",
    "author": "Your Name",
    "version": (3, 0, 0),
    "blender": (5, 0, 0),
    "location": "Graph Editor > N Panel > Anim Lattice",
    "description": "FINAL VERSION - WILL WORK",
    "category": "Animation",
}

import bpy
from bpy.props import FloatProperty

def get_keyframes():
    """SIMPLEST possible keyframe detection"""
    count = 0
    for obj in bpy.context.scene.objects:
        if obj.animation_data and obj.animation_data.action:
            for fcurve in obj.animation_data.action.fcurves:
                for point in fcurve.keyframe_points:
                    if point.select_control_point:
                        count += 1
    return count

class ANIMLATTICE_OT_test_button(bpy.types.Operator):
    """Test button - proves addon works"""
    bl_idname = "animlattice.test"
    bl_label = "TEST BUTTON"
    
    def execute(self, context):
        count = get_keyframes()
        self.report({'INFO'}, f"Found {count} selected keyframes!")
        return {'FINISHED'}

class ANIMLATTICE_PT_panel(bpy.types.Panel):
    """Anim Lattice Panel - BULLETPROOF"""
    bl_label = "Anim Lattice"
    bl_idname = "ANIMLATTICE_PT_panel"
    bl_space_type = 'GRAPH_EDITOR'
    bl_region_type = 'UI'
    bl_category = "Anim Lattice"  # Custom tab name
    
    def draw(self, context):
        layout = self.layout
        kf_count = get_keyframes()
        
        # BIG GREEN STATUS
        row = layout.row()
        row.scale_y = 2.0
        if kf_count > 0:
            row.label(text=f"‚úÖ {kf_count} KEYS SELECTED!", icon='KEY_HLT')
        else:
            row.label(text="‚ùå NO KEYS SELECTED", icon='INFO')
        
        # TEST BUTTON (proves addon loads)
        layout.operator("animlattice.test", icon='PLAY')
        
        if kf_count == 0:
            box = layout.box()
            box.label(text="üöÄ QUICK SETUP:")
            box.label(text="1. Select animated object")
            box.label(text="2. Graph Editor ‚Üí B (box select keyframes)")
            return
        
        # WORKING OPERATORS
        box = layout.box()
        box.label(text="Retime (Horizontal)", icon='TIME')
        col = box.column(align=True)
        col.operator("animlattice.scale_time", text="Fast 0.8x").scale_factor = 0.8
        col.operator("animlattice.scale_time", text="Slow 1.2x").scale_factor = 1.2
        
        box = layout.box()
        box.label(text="Scale (Vertical)", icon='ARROW_LEFTRIGHT')
        col = box.column(align=True)
        col.operator("animlattice.scale_value", text="Small 0.8x").scale_factor = 0.8
        col.operator("animlattice.scale_value", text="Big 1.2x").scale_factor = 1.2[web:76]

class ANIMLATTICE_OT_scale_time(bpy.types.Operator):
    bl_idname = "animlattice.scale_time"
    bl_label = "Scale Time"
    bl_options = {'REGISTER', 'UNDO'}
    scale_factor: FloatProperty(default=1.0)
    
    def execute(self, context):
        count = 0
        for obj in context.scene.objects:
            if obj.animation_data and obj.animation_data.action:
                action = obj.animation_data.action
                times = []
                for fcurve in action.fcurves:
                    for point in fcurve.keyframe_points:
                        if point.select_control_point:
                            times.append(point.co[0])
                
                if times:
                    center = sum(times) / len(times)
                    for fcurve in action.fcurves:
                        for point in fcurve.keyframe_points:
                            if point.select_control_point:
                                old_time = point.co[0]
                                new_time = center + (old_time - center) * self.scale_factor
                                point.co[0] = new_time
                                point.handle_left[0] += new_time - old_time
                                point.handle_right[0] += new_time - old_time
                                count += 1
        
        for area in context.screen.areas:
            if area.type == 'GRAPH_EDITOR':
                area.tag_redraw()
        
        self.report({'INFO'}, f"Retimed {count} keyframes")
        return {'FINISHED'}

class ANIMLATTICE_OT_scale_value(bpy.types.Operator):
    bl_idname = "animlattice.scale_value"
    bl_label = "Scale Value"
    bl_options = {'REGISTER', 'UNDO'}
    scale_factor: FloatProperty(default=1.0)
    
    def execute(self, context):
        count = 0
        for obj in context.scene.objects:
            if obj.animation_data and obj.animation_data.action:
                values = []
                for fcurve in obj.animation_data.action.fcurves:
                    for point in fcurve.keyframe_points:
                        if point.select_control_point:
                            values.append(point.co[1])
                
                if values:
                    center = sum(values) / len(values)
                    for fcurve in obj.animation_data.action.fcurves:
                        for point in fcurve.keyframe_points:
                            if point.select_control_point:
                                old_value = point.co[1]
                                new_value = center + (old_value - center) * self.scale_factor
                                point.co[1] = new_value
                                count += 1
        
        for area in context.screen.areas:
            if area.type == 'GRAPH_EDITOR':
                area.tag_redraw()
        
        self.report({'INFO'}, f"Scaled {count} keyframes")
        return {'FINISHED'}

classes = (ANIMLATTICE_PT_panel, ANIMLATTICE_OT_test_button, 
           ANIMLATTICE_OT_scale_time, ANIMLATTICE_OT_scale_value)

def register():
    for cls in classes:
        bpy.utils.register_class(cls)
    print("‚úÖ Anim Lattice FINAL registered!")

def unregister():
    for cls in reversed(classes):
        bpy.utils.unregister_class(cls)

if __name__ == "__main__":
    register()
